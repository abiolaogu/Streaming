# StreamVerse Streaming-as-a-Service - Complete Production Stack
# On-Premise Infrastructure with Hybrid GPU Scaling (Runpod.io)
# 2.5x cheaper than Cloudflare Stream ($0.40 vs $1.00 per 1000 mins)

version: '3.9'

services:
  # ==================== INGESTION LAYER ====================
  ingestion-service:
    build:
      context: ./ingestion-service
      dockerfile: Dockerfile
    image: streamverse/ingestion:1.0.0
    container_name: ingestion-service
    ports:
      - "8100:8100"      # HTTP API
      - "1935:1935"      # RTMP
      - "8554:8554"      # RTSP
      - "9999:9999/udp"  # SRT
    environment:
      - RUST_LOG=info
      - MAX_CONCURRENT_STREAMS=10000
      - STORAGE_ENDPOINT=http://minio:9000
      - KAFKA_BROKERS=kafka:9092
      - REDIS_URL=redis://redis:6379
    volumes:
      - ingestion-buffer:/tmp/buffer
    networks:
      - streaming-network
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==================== TRANSCODING LAYER ====================
  transcoding-service:
    build:
      context: ./transcoding-service
      dockerfile: Dockerfile
    image: streamverse/transcoding:1.0.0
    container_name: transcoding-service
    ports:
      - "8101:8101"
    environment:
      - RUST_LOG=info
      - GPU_ACCELERATION=true
      - NVIDIA_VISIBLE_DEVICES=all
      - FFMPEG_THREADS=8
      - KAFKA_BROKERS=kafka:9092
      - STORAGE_ENDPOINT=http://minio:9000
      # Runpod.io Hybrid GPU Scaling
      - RUNPOD_API_KEY=${RUNPOD_API_KEY}
      - RUNPOD_GPU_TYPE=RTX4090
      - RUNPOD_MAX_PODS=10
      - RUNPOD_AUTO_SCALE=true
      - LOCAL_GPU_COUNT=4
    runtime: nvidia  # NVIDIA GPU support
    volumes:
      - transcoding-cache:/cache
    networks:
      - streaming-network
    deploy:
      resources:
        limits:
          cpus: '8.0'
          memory: 16G
        reservations:
          cpus: '4.0'
          memory: 8G
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8101/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==================== AI ENHANCEMENT ====================
  ai-enhancement-service:
    build:
      context: ./ai-enhancement-service
      dockerfile: Dockerfile
    image: streamverse/ai-enhancement:1.0.0
    container_name: ai-enhancement-service
    ports:
      - "8102:8102"
    environment:
      - PYTHONUNBUFFERED=1
      - CUDA_VISIBLE_DEVICES=0
      - MODEL_CACHE=/models
      - KAFKA_BROKERS=kafka:9092
    runtime: nvidia
    volumes:
      - ai-models:/models
    networks:
      - streaming-network
    deploy:
      resources:
        limits:
          cpus: '8.0'
          memory: 32G
        reservations:
          cpus: '4.0'
          memory: 16G
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped

  # ==================== DRM & SECURITY ====================
  drm-service:
    build:
      context: ./drm-service
      dockerfile: Dockerfile
    image: streamverse/drm:1.0.0
    container_name: drm-service
    ports:
      - "8103:8103"
    environment:
      - GO_ENV=production
      - WIDEVINE_PROVIDER_KEY=${WIDEVINE_KEY}
      - FAIRPLAY_CERT=${FAIRPLAY_CERT}
      - BLOCKCHAIN_RPC=${ETHEREUM_RPC}
      - REDIS_URL=redis://redis:6379
    networks:
      - streaming-network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
    restart: unless-stopped

  # ==================== DELIVERY LAYER ====================
  delivery-service:
    build:
      context: ./delivery-service
      dockerfile: Dockerfile
    image: streamverse/delivery:1.0.0
    container_name: delivery-service
    ports:
      - "8104:8104"  # HTTP API
      - "3478:3478/udp"  # STUN
      - "10000-10100:10000-10100/udp"  # WebRTC
    environment:
      - RUST_LOG=info
      - P2P_ENABLED=true
      - CDN_ENDPOINTS=${CDN_ENDPOINTS}
      - REDIS_URL=redis://redis:6379
    networks:
      - streaming-network
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
    restart: unless-stopped

  # ==================== ANALYTICS LAYER ====================
  analytics-service:
    build:
      context: ./analytics-service
      dockerfile: Dockerfile
    image: streamverse/analytics:1.0.0
    container_name: analytics-service
    ports:
      - "8105:8105"
    environment:
      - GO_ENV=production
      - SCYLLADB_HOSTS=scylla:9042
      - CLICKHOUSE_HOST=clickhouse:9000
      - KAFKA_BROKERS=kafka:9092
    networks:
      - streaming-network
    depends_on:
      - scylla
      - clickhouse
      - kafka
    restart: unless-stopped

  # ==================== API GATEWAY ====================
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    image: streamverse/api-gateway:1.0.0
    container_name: api-gateway
    ports:
      - "8080:8080"  # HTTP
      - "8443:8443"  # HTTPS
    environment:
      - GO_ENV=production
      - JWT_SECRET=${JWT_SECRET}
      - RATE_LIMIT_RPS=10000
      - REDIS_URL=redis://redis:6379
    networks:
      - streaming-network
    depends_on:
      - redis
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
    restart: unless-stopped

  # ==================== STORAGE LAYER ====================
  minio:
    image: minio/minio:latest
    container_name: minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=${MINIO_PASSWORD}
      - MINIO_REGION=us-east-1
    volumes:
      - minio-data:/data
    networks:
      - streaming-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    restart: unless-stopped

  # ==================== DATABASES ====================
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=streamverse
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=streamverse
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - streaming-network
    restart: unless-stopped

  scylla:
    image: scylladb/scylla:latest
    container_name: scylla
    command: --smp 4 --memory 8G
    ports:
      - "9042:9042"
    volumes:
      - scylla-data:/var/lib/scylla
    networks:
      - streaming-network
    restart: unless-stopped

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse-data:/var/lib/clickhouse
    networks:
      - streaming-network
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: redis
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - streaming-network
    restart: unless-stopped

  # ==================== MESSAGING ====================
  kafka:
    image: bitnami/kafka:latest
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
    volumes:
      - kafka-data:/bitnami/kafka
    networks:
      - streaming-network
    restart: unless-stopped

  # ==================== MONITORING ====================
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    networks:
      - streaming-network
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
    volumes:
      - grafana-data:/var/lib/grafana
    networks:
      - streaming-network
    restart: unless-stopped

  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger
    ports:
      - "16686:16686"  # UI
      - "14268:14268"  # Collector
    networks:
      - streaming-network
    restart: unless-stopped

volumes:
  ingestion-buffer:
  transcoding-cache:
  ai-models:
  minio-data:
  postgres-data:
  scylla-data:
  clickhouse-data:
  redis-data:
  kafka-data:
  prometheus-data:
  grafana-data:

networks:
  streaming-network:
    driver: bridge
