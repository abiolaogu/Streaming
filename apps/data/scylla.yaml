apiVersion: v1
kind: Service
metadata:
  name: scylla-svc
  namespace: data
  labels:
    app: scylla
spec:
  ports:
  - port: 9042
    targetPort: 9042
    name: cql
  - port: 10000
    targetPort: 10000
    name: prometheus
  selector:
    app: scylla
  clusterIP: None
---
apiVersion: v1
kind: Service
metadata:
  name: scylla-client
  namespace: data
  labels:
    app: scylla
spec:
  ports:
  - port: 9042
    targetPort: 9042
    name: cql
  selector:
    app: scylla
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: scylla
  namespace: data
  labels:
    app: scylla
spec:
  serviceName: scylla-svc
  replicas: 3
  selector:
    matchLabels:
      app: scylla
  template:
    metadata:
      labels:
        app: scylla
    spec:
      priorityClassName: data-critical
      containers:
      - name: scylla
        image: scylladb/scylla:5.4.8
        ports:
        - containerPort: 9042
          name: cql
        - containerPort: 10000
          name: prometheus
        env:
        - name: SCYLLA_CLUSTER_NAME
          value: "streaming-platform"
        - name: SCYLLA_DC
          value: "datacenter1"
        - name: SCYLLA_RACK
          value: "rack1"
        - name: SCYLLA_BROADCAST_ADDRESS
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: SCYLLA_LISTEN_ADDRESS
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: SCYLLA_BROADCAST_RPC_ADDRESS
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: SCYLLA_RPC_ADDRESS
          value: "0.0.0.0"
        - name: SCYLLA_SEEDS
          value: "scylla-0.scylla-svc.data.svc.cluster.local,scylla-1.scylla-svc.data.svc.cluster.local,scylla-2.scylla-svc.data.svc.cluster.local"
        - name: SCYLLA_DEVELOPER_MODE
          value: "false"
        - name: SCYLLA_AGENT_PROMETHEUS_ADDRESS
          value: "0.0.0.0:10000"
        resources:
          requests:
            cpu: "4000m"
            memory: 32Gi
          limits:
            cpu: "16000m"
            memory: 64Gi
        volumeMounts:
        - name: data
          mountPath: /var/lib/scylla
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - nodetool status | grep UN
          initialDelaySeconds: 90
          periodSeconds: 30
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - nodetool status | grep UN
          initialDelaySeconds: 60
          periodSeconds: 20
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 500Gi
---
apiVersion: batch/v1
kind: Job
metadata:
  name: scylla-schema-init
  namespace: data
spec:
  template:
    spec:
      containers:
      - name: cqlsh
        image: scylladb/scylla:5.4.8
        command:
        - /bin/sh
        - -c
        - |
          until cqlsh scylla-client.data.svc.cluster.local -e "DESCRIBE KEYSPACE system"; do
            echo "Waiting for ScyllaDB..."
            sleep 5
          done
          
          cqlsh scylla-client.data.svc.cluster.local -f /init/schema.cql
        volumeMounts:
        - name: schema
          mountPath: /init
      volumes:
      - name: schema
        configMap:
          name: scylla-schema
      restartPolicy: Never
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: scylla-schema
  namespace: data
data:
  schema.cql: |
    CREATE KEYSPACE IF NOT EXISTS streaming_platform
    WITH replication = {
      'class': 'NetworkTopologyStrategy',
      'datacenter1': '3'
    };
    
    USE streaming_platform;
    
    CREATE TABLE IF NOT EXISTS catalog (
      video_id uuid PRIMARY KEY,
      title text,
      duration int,
      formats list<text>,
      encodings map<text, text>,
      drm_protected boolean,
      created_at timestamp,
      updated_at timestamp
    );
    
    CREATE TABLE IF NOT EXISTS entitlement (
      user_id text,
      video_id uuid,
      entitlement_type text,
      expires_at timestamp,
      drm_key_id text,
      PRIMARY KEY (user_id, video_id)
    );
    
    CREATE TABLE IF NOT EXISTS replay_token (
      token text PRIMARY KEY,
      user_id text,
      video_id uuid,
      position int,
      expires_at timestamp
    );
    
    CREATE TABLE IF NOT EXISTS counters (
      metric_name text,
      video_id uuid,
      timestamp timestamp,
      count counter,
      PRIMARY KEY (metric_name, video_id, timestamp)
    ) WITH default_time_to_live = 86400;
    
    CREATE MATERIALIZED VIEW IF NOT EXISTS entitlement_by_video AS
      SELECT video_id, user_id, entitlement_type, expires_at, drm_key_id
      FROM entitlement
      WHERE video_id IS NOT NULL AND user_id IS NOT NULL
      PRIMARY KEY (video_id, user_id);

