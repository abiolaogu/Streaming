name: StreamVerse CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: streamverse-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  discover-go-modules:
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.discover.outputs.modules }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Discover Go Modules
        id: discover
        run: |
          modules_json=$(python3 - <<'PY'
          import json
          import pathlib

          modules = sorted(
              str(path.parent)
              for path in pathlib.Path(".").rglob("go.mod")
              if ".git" not in path.parts
          )

          print(json.dumps(modules))
          PY
          )
          echo "modules=${modules_json}" >> "$GITHUB_OUTPUT"

  go-modules:
    needs: discover-go-modules
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        module: ${{ fromJson(needs.discover-go-modules.outputs.modules) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ matrix.module }}/go.mod
          cache-dependency-path: |
            ${{ matrix.module }}/go.sum

      - name: Test Module
        run: |
          cd "${{ matrix.module }}"
          go test ./...

  web-client:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Run Web Checks
        run: npm run check

      - name: Security Audit
        run: npm audit --audit-level=high

  node-services:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - services/notification-service
          - services/websocket-service
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Validate Service
        run: |
          cd "${{ matrix.service }}"
          npm install --no-audit --no-fund
          npm run lint --if-present
          npm run test --if-present

  python-services:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - services/analytics-service
          - services/recommendation-service
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Validate Python Service
        run: |
          pip install -r "${{ matrix.service }}/requirements.txt"
          python -m compileall -q "${{ matrix.service }}"

  security-baseline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Insecure Defaults
        run: ./scripts/ci/check-no-insecure-defaults.sh
